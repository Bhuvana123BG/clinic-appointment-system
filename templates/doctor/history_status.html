{% extends "base.html" %}
{% load static %}
{% block content %}

{% include "includes/nav_doc.html" %}
{% include "includes/messages.html" %}

<div class="container my-5">

  <!-- Page Heading -->
  <h3 class="mb-4 text-primary text-center"><i class="bi bi-clock-history me-2"></i>{{ title }}</h3>

  <!-- Appointments List -->
  {% if appointments %}
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle shadow-sm">
        <thead class="table-light">
          <tr>
            <th>Patient</th>
            <th>Date & Time</th>
            <th>Reason / Message</th>
            {% if status_filter == 'pending' %}
              <th>Actions</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for a in appointments %}
            <tr>
              <td>{{ a.patient.user.username|title }}</td>
              <td>{{ a.date|date:"M d, Y h:i A" }}</td>
              <td>
                {% if a.status == "APPROVED" %}
                  ✅ {{ a.doctor_message|default:"—" }}
                {% elif a.status == "REJECTED" %}
                  ❌ {{ a.rejection_message|default:"—" }}
                {% else %}
                  ⏳ {{ a.reason|default:"—" }}
                {% endif %}
              </td>

              {% if status_filter == 'pending' %}
              <td>
                <!-- Approve/Reject buttons with modal -->
                <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#approve{{ a.id }}">
                  <i class="bi bi-check-circle"></i>
                </button>
                <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#reject{{ a.id }}">
                  <i class="bi bi-x-circle"></i>
                </button>

                <!-- Approve Modal -->
                <div class="modal fade" id="approve{{ a.id }}" tabindex="-1">
                  <div class="modal-dialog">
                    <form method="post" action="{% url 'approve_request' a.id %}" class="modal-content">
                      {% csrf_token %}
                      <div class="modal-header">
                        <h5 class="modal-title">Approve Appointment</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body">
                        <label class="form-label">Confirmation message (optional)</label>
                        <textarea name="doctor_message" class="form-control" placeholder="See you at the scheduled time."></textarea>
                      </div>
                      <div class="modal-footer">
                        <button class="btn btn-success">Approve</button>
                      </div>
                    </form>
                  </div>
                </div>

                <!-- Reject Modal -->
                <div class="modal fade" id="reject{{ a.id }}" tabindex="-1">
                  <div class="modal-dialog">
                    <form method="post" action="{% url 'reject_request' a.id %}" class="modal-content">
                      {% csrf_token %}
                      <div class="modal-header">
                        <h5 class="modal-title">Reject Appointment</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body">
                        <label class="form-label">Reason (required)</label>
                        <textarea name="rejection_message" class="form-control" required placeholder="Not available at that time."></textarea>
                      </div>
                      <div class="modal-footer">
                        <button class="btn btn-danger">Reject</button>
                      </div>
                    </form>
                  </div>
                </div>

              </td>
              {% endif %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="card shadow-sm p-4 text-center">
      <h5 class="text-muted mb-0">No records found.</h5>
    </div>
  {% endif %}

</div>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

{% endblock %}
